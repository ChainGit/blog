---
title: 记录一次家中路由改造和监控升级
date: 2018/01/22
categories: 其他
tags:
- 其他
---

记录一次家中路由改造和监控升级
===============================
随着智能手机的普及，越来越多的人使用手机看高清视频、玩手机游戏。渐渐的，家里门面上的路由无线网络也吃不消了，现在回到家进行了一下改造，改造过程不难，记录一下。

## 路由改造

家中的路由以前是水星普通家用路由器，从某东上买来一个普通的企业级路由器。将企业级路由器作为直接接入光猫端，以前的水星路由器作为子网，成树状结构。子网内的路由器相互进行WDS无线桥接，每个路由器都有各自的网线连接到企业级路由器。这样就可以实现家里的无线网络的全覆盖和流量分散，不像之前全部集中在一个路由器上，路由器处理不过来，导致经常卡顿、掉线。

### 树状结构

主企业级路由器关闭DHCP，改为手动配置IP、网关、DNS等信息。子路由器固定IP连接到主路由器。主路由器开启IP和MAC绑定。子路由器关闭uPnP功能（迅雷等软件可能会占用所有的路由器带宽和计算资源）。子路由器在同一个子网下，与主路由器不在一个子网。子路由器开启指定MAC访问配置界面。主路由器没有无线模块。

大致示意图如下：[png](/uploads/0-common-images/26.png)
![示意图](/uploads/0-common-images/25.svg)


### WDS组网

WDS组网是无线路由的常用功能，现在的路由新的配置界面可以一键实现路由无线桥接，但是一键有好处也有不好。组网的机器最好是同厂家，不同厂家也可以，不多不排除会有掉线的问题。每个子路由器都通过有线接入主路由器，这样WDS组网后，每个路由器的向外访问的数据包会直接从各自路由器走，内部互相访问的流量才在子网内访问，避免桥接的网络数据拥堵（可以从路由的系统路由表得到这个结论）。子路由在使用人多的地方可以使用多天线，即带宽高一点，这样支持同时访问的人数就可以多一点。主路由器可以对每一个子路由器进行网速的限制。

WDS组网的注意事项是：每个路由器无线所使用的信道需要一致（不能为自动），DHCP的分配地址不能有重叠，每个子路由的网关不能有冲突。

## 监控升级

家里的监控用的是海康威视DS-7804H-SNH，型号比较老。以前使用HiDDNS能实现远程实时预览和回放。突然有一天远程访问不能使用。检查后发现，一方面旧的HiDDNS海康已经不再支持，虽然旧型号仍然可以使用；另一方面，也是最重要的。家里的拨号后获取的IP竟然变成了100开头的IP地址，这是内网的IP。而海康获取到的IP为NAT后的公网IP，内网映射的端口如果直接从外网访问当然是访问不了，需要获取到外网映射的端口才行，但是外网映射的端口也是在不断变化的，这和[UDP的聊天室](https://www.leechain.top/blog/2017/12/05-udp-chat-room.html)是一个道理。没办法解决自己家中的网络被电信机房接入了内网的事实，只能另找其他办法。海康也推出了萤石云，萤石云可以解决这个问题，不再使用HiDDNS。不过萤石云官网上说明只是在新的机子上支持。

功夫不负有心人，在论坛上成功的找到DS-7804H-SNH的升级包，使用U盘插入升级后再重置（最好重置一下），设置中多了一个萤石云的选项。看来可行。

先配置好监控的常用设置，开启移动侦测，关闭定时录像，以节省硬盘空间。将监控接入主路由器，配置好IP等信息。下载萤石云视频APP，注册账号，然后在监控机器的网页界面（使用IE，兼容界面，安装WebComponent插件）可以获取到设备的9位ID，在监控的本机（不是网页）可以设置萤石云的访问的验证码（也可以不设置，设置后可以加密流）。通过萤石云视频APP，绑定好账号后就可以实时公网预览了。

![image](/uploads/0-common-images/27.jpg)

然后下载APP名iVMS-4500，先手动添加内网访问监控的配置，然后再登陆上萤石云账号，同步刚才的萤石云视频APP的设置，就可以实现内网和外网都可以观看监控和回放了。萤石云视频APP也可以卸载，保留一个iVMS4500即可。

## 思考总结

这样折腾一番后，家里的无线网络掉线现象得到明显的改善，监控也能愉快的内外网同时访问了。